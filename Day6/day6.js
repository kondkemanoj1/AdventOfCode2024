function findObstructionPositions(map) {
    const directions = [
        { dx: 0, dy: -1 }, // Up
        { dx: 1, dy: 0 },  // Right
        { dx: 0, dy: 1 },  // Down
        { dx: -1, dy: 0 }  // Left
    ];

    let grid = map.trim().split("\n").map(row => row.split(""));
    const rows = grid.length;
    const cols = grid[0].length;

    // Find the guard's starting position and direction
    let guard = { x: 0, y: 0, dir: 0 };
    const symbols = { "^": 0, ">": 1, "v": 2, "<": 3 };
    for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
            if ("^>v<".includes(grid[y][x])) {
                guard = { x, y, dir: symbols[grid[y][x]] };
                grid[y][x] = "."; // Replace guard's starting position with empty space
                break;
            }
        }
    }

    function simulate(grid) {
        let guardState = { ...guard };
        const visitedStates = new Set();
        visitedStates.add(`${guardState.x},${guardState.y},${guardState.dir}`);

        while (true) {
            const { dx, dy } = directions[guardState.dir];
            const nx = guardState.x + dx;
            const ny = guardState.y + dy;

            if (nx < 0 || ny < 0 || nx >= cols || ny >= rows) {
                return false; // Guard leaves the map
            }

            if (grid[ny][nx] === "#") {
                // Obstacle: turn right
                guardState.dir = (guardState.dir + 1) % 4;
            } else {
                // Move forward
                guardState.x = nx;
                guardState.y = ny;
            }

            const stateKey = `${guardState.x},${guardState.y},${guardState.dir}`;
            if (visitedStates.has(stateKey)) {
                return true; // Guard is stuck in a loop
            }
            visitedStates.add(stateKey);
        }
    }

    const validPositions = new Set();
    for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
            if (grid[y][x] === "." && !(x === guard.x && y === guard.y)) {
                // Temporarily place an obstruction and test
                grid[y][x] = "#";
                if (simulate(grid)) {
                    validPositions.add(`${x},${y}`);
                }
                grid[y][x] = "."; // Remove obstruction
            }
        }
    }

    return validPositions.size;
}

// Puzzle input
const map = `
.......#.........#..............#........................#......#....#............................#..#...............#............
...................#.............................................#...................................#............................
...............#.................................##.........#..........#.....##...#...#.....#....#..................#.............
#.............................................#..#.............#..........#.##.............................................#......
#.........................................................#.....#........................................##.......................
...........#.......#.#...........#....#.#...#......................................#...........................#...##............#
........................................................#..#.....................................#..#................#....#...#...
#.#.....#.........................#...........#.......................................#.......#.....................##............
.......#..........##.....#........#..................................................#.........................................#.#
#.#..............#.#.............................#............#....#...............#.........................#............#..#.#.#
..........................................................#....................................................#..................
.......................#....#...........#.....................#....#...#.......#..............#.......................#...........
..............................#..............#.......#....................................#.....................#...#...#.........
........#.................#...#....##..............#...........................#............................#.................#...
..................#........................................#......#......................................................#........
.............#.................#...#..............................................................................#...#...........
.....................................#..........................................................#.#.#......#.........#............
..........#...................................................................#.........##.......#..#.............................
...#.#....................................#..#...........#.......................................................##...............
........................................................................................................#.........................
.........#...........#......#..............#........#....................#...#......#.............................................
........#....#...............#....................#..........#.....................................#......#......#........#.#.....
........................#..........................#.......#........................#................#......#.....................
......................................#.........................................#............................#....................
...................................#.#...#...........#.........................................#.....................#............
.................#....#.....................................................................#..................#.........#........
...........#...........................................................#.............................#...............#..#.........
..#.....................#.........................................................................................................
....................#....#.#...........................#...........................................#..............#...............
...#...................................................#.............................................#.........#..........#.......
.............................###.....#..#..#......................................................................................
##................#.#.......#..............#.....#...............#..#............#................................................
......#...............................................#.#..#............................#............#.................#..........
........................................#.#...................................................#.....#.............................
#.......#.#.......................#.....#....................................#...................#................................
...##................................................................................................#.....................#......
............#.............#..................#.................#..................................................................
...#..............#..............................................................................#..........#......#..............
...#..#...#................................................#.....................#......#......................#.......#..........
.................#..#........#...............#.#................#......##.................#.................................#.....
#.....#.......#...........................................#..........#..............................#...#.#..#......#.....#.......
....................................#.........#........#..................#.............................................#.........
#...............................#........................#.................................................#.....#................
..#..................................#.......#.....................#..............................................................
........#...#.....................................#......#..............#..#..#..........................#.#....#.................
.............#..........#....#................#.......#..........................................#.....#..........................
.............................................#................................#.........................#...#.....................
.........#........#...................................................................#.......#....#..............................
....................................#.......................#..............#...............................#......................
....#....................#................................#....#...........#.............#........................................
....#...........#...................#.#..................................................#.....................#..................
..........#....................#............#.##...#.......#....#...............#.....#...#.........................#.............
.......#....................................................................................................#.................#...
...............................................................................#......#.................#...#.....................
..................#........#..........#..........................................................................#................
..........................................................................................#.......................................
.#..#...........#.................................##...........................#.....#...................#..#.....................
........................#..#..........................................................#............#..................#..........#
...........#...................................................##...........................#...............................#.....
........#......................................................................................................#..................
........#..#............................#..#...........#..............................#......................#.##...........#....#
........#...#.#..............#...#.....................#....................#.#..............................#....................
.......................................................#....................................................#..#..................
...........................................#......................#................#........................#....................#
.............#...............#................................................................................#...................
..#...#............#.............#.....#........................#............#....................#...............................
.....#...................................................................................................................#........
....................#..#...........#....#.............................................................................#.......#...
..............#......#.........................#...........#...#...........................................#...#..................
..............................#.....#.........................................................#......#.#......#...................
............................................................#...................#.#............................#..................
.............###.#........................................#........................................................#..............
......#................................#...............##.........................................................................
.........#.....#.#.....................#.......................................#...............#..........#....#....#.............
..............................................#....................................#...........................................#..
............#.#..........#........#..#.....#.............#..........#............#......#...................##..........#.........
............#....#...................................#.............................#.........................#....................
.#..................................#....#.........................................................................#..............
.........................#...#...#.................#..................#.............#.#...#...............#.......................
.........#...............................#...........#.............................#...........................#..........#.......
......#..........................#.............#..........#.......................................................................
.......#...............#.........#.............#...............................#..................................................
..#......#....................##...........................................#........................................#.............
..........................#.....#.......................#...........................................................#.#...........
..#....................#.............#................................................................#.#.........................
.........#....................#.....#....#...............#.......................#........#.......................................
..............#...................................................................#................#...#..........................
....................#.....#.......#..#......................................#...........#..................................##....#
.......#.......................................................................#..................................................
......#.............##..........................#..#......................^.......................................................
..............................#..........#...................#.................................#.....................#............
.......................##..........................#.......#..............................#...................................#.#.
................#....................................................................#...............................#.........#..
..........................................#......#.....................................#................#........#................
#......................................#.......................................................#..#...........#...................
.......#.............#..................#..#...#............#.......#.....#.....#.#...............................................
.............................#........#.............#.....#.......#...................................#.#..................#......
.................#......................................................................................#........#..#.............
........................................................................#..............#.....#..............................#.....
....#....#..........................................#......##...#....................#...................#..........#.............
.................##.......................##.#.........#................................................#.........................
.#..............................................#.........................#.#.#..........#.....................................##.
............................................................#..........#....#...................................................#.
....#...........#.............................#.....................#.........#..................#...........................#....
......#.#.......#..#......#........#..#...................#....#..................................................................
............#........................................................................................................#............
.....................................................#..........................................#................#................
...#.......#..#..............#.............................#....................................#.................................
.................##.........#........................#....................................#...............#.#.#...................
................#......#......................#..#..........................................#.....................................
......#..................................................##.#.#........#...........................#.......................#......
........................#............#......#.........#.............#.............................................#.....#.##......
......................#........................................#.......#.........#.................#..#...........#...............
..#.......#.........##..#.#................................................................................#.........#............
........................................................................................#............#...........#................
................#...#....................#..##..#...............#.............................................................#...
...#........#..........................#.....#..........................#....................................#.........#.......##.
.................#...........................#.........#......#............................#.....................#................
...................#..........#....#.......#...................#.............................#..........#.........................
.......#..............#.................................#.........#....................................#.................#....##.#
..................................#.......................#....#..#.........................#....................#................
.....#.........#............#...#.........#........#...................#...#......................#.....#............#............
#.#....#...#........#................................##..........................#.............................##...#....#........
.............##..........##...#......#.......#.#................#.#.......................#.............#.........................
.............#....................................#....................................#..........................................
..................................#..............................#.......................................#................#.......
...................#...............#..............................................................................................
....#........#.................................#........#.....................................#.......#................#........#.
.................#......#.......................................................##.....#..................#.......................
...............#.......................#.#........#...........................................#........#..........................
`;

console.log(findObstructionPositions(map)); 